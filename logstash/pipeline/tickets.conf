input {
  jdbc {
    jdbc_connection_string => "jdbc:postgresql://db:5432/nnpda-db"
    jdbc_user => "sa"
    jdbc_password => "pwd"
    jdbc_driver_library => "/usr/share/logstash/jars/postgresql-42.6.0.jar"
    jdbc_driver_class => "org.postgresql.Driver"
    schedule => "*/1 * * * *"  # každou minutu
    statement => "SELECT * FROM app_tickets"
  }
}

filter {
  ruby {
    code => '
      # Priority mapping
      case event.get("priority")
      when 1, "1"
        event.set("priority", "LOW")
      when 2, "2"
        event.set("priority", "MEDIUM")
      when 3, "3"
        event.set("priority", "HIGH")
      when "LOW", "MEDIUM", "HIGH"
        # necháme beze změny
      else
        event.set("priority", "UNKNOWN")
      end
    '
  }

  date {
    match => ["updated", "ISO8601"]
    target => "updated"
    remove_field => ["@version", "timestamp"]
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "tickets"
    document_id => "%{id}"  # update existujících dokumentů
  }
}
